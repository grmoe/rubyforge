import MySQLdb
import csv

db = MySQLdb.connect(host = "hostname", user = "username", passwd = "password", db = "rubyforge", use_unicode = True, charset = "utf8")

cursor = db.cursor()
cursor.execute("SET NAMES utf8mb4")
cursor.execute("SET Character set utf8mb4")
cursor.execute("SET character_set_connection = utf8mb4")



# Get a list of Data sources
cursor.execute("SELECT DISTINCT datasource_id FROM `rf_developers` ORDER BY `datasource_id` ASC")
results = cursor.fetchall()
datasources = []

for i in results:
    datasources.append(i[0])


devs = {}
counter = 0

for i in datasources:
    # Get a list of projects with more than one developer contributing
    gpl = [] #GROUP PROJECT LIST
    cursor.execute("SELECT proj_unixname FROM `rf_developer_projects` WHERE datasource_id = %s",(i))
    results = cursor.fetchall()
    for j in range(1,len(results)):
        proj1 = results[j-1][0]
        proj2 = results[j][0]
        if proj2 not in gpl:
            if proj2 == proj1:
                gpl.append(proj2)
                   
    # Network the developers
    for j in gpl:
        cursor.execute("SELECT dev_loginname FROM `rf_developer_projects` WHERE datasource_id = %s AND proj_unixname = %s",(i,j))
        results = cursor.fetchall()
        projdevs = []
        for k in results:
            projdevs.append(k[0])
        for k in projdevs:
            dev1 = k
            for l in projdevs:
                dev2 = l
                if dev1 != dev2:
                    if dev2 in devs:
                        if dev1 not in devs[dev2]:
                            if dev1 in devs:
                                devs[dev1].append(dev2)
                            else:
                                devs[dev1] = [dev2]
                    else:
                        if dev1 in devs:
                            devs[dev1].append(dev2)
                        else:
                            devs[dev1] = [dev2]
            

    filename = "C:\Users\gmoe\Desktop\CSVFiles\ds%s-developer-network.csv" % (i)
    #filename2 = "C:\Users\gmoe\Desktop\CSVFiles2\ds%s-developer-network.csv" % (counter)
    #counter += 1
    
    with open(filename, 'wb') as f:
        wr = csv.writer(f,quoting=csv.QUOTE_ALL)
        for j in devs:
            row = [j]
            for k in devs[j]:
                row.append(k)
            wr.writerow(row)
    
    #with open(filename2, 'wb') as f:
    #    wr = csv.writer(f,quoting=csv.QUOTE_ALL)
    #    for j in devs:
    #        row = [j]
    #        for k in devs[j]:
    #            row.append(k)
    #        wr.writerow(row)

cursor.close()
db.close()
